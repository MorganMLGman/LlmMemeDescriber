{% extends "base.html" %}

{% block title %}Meme Describer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/style.css?v=3">
{% endblock %}

{% block navbar_controls %}
<input type="text" id="searchInput" class="form-control form-control-sm" 
       style="width: 250px;" placeholder="Search memes..." onkeyup="handleSearch()">
<button type="button" id="clearSearchBtn" class="btn btn-sm btn-secondary" onclick="clearSearch()" 
        style="display: none;">Clear</button>
<button class="btn btn-sm btn-outline-light" onclick="startSyncJob()">Refresh</button>
{% endblock %}

{% block content %}
<!-- Stats & Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h6 class="card-title mb-0">
                        <span id="statsText">Loading...</span>
                    </h6>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-info" id="viewDuplicatesBtn" onclick="window.location.href='/duplicates'" style="display: none;">
                            üìã View Duplicates
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Duplicates List Panel (hidden by default) -->
<div id="duplicatesListPanel" class="card bg-light mb-4" style="display: none;">
    <div class="card-header">
        <h5 class="mb-0">Duplicate Groups</h5>
    </div>
    <div class="card-body" id="duplicatesListContent" style="max-height: 500px; overflow-y: auto;">
        <!-- Groups will be inserted here -->
    </div>
</div>

<!-- Memes Grid -->
<div class="row g-3 mb-4" id="memesContainer">
    <!-- Memes will be inserted here -->
</div>

<!-- Loading Indicator -->
<div class="text-center mb-4">
    <div class="spinner-border" id="loadingIndicator" style="display: none;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- End of List Message -->
<div class="text-center" id="endOfListMessage" style="display: none;">
    <p class="text-muted">No more memes to load</p>
</div>

<!-- Meme Modal -->
<div class="modal fade" id="memeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memeTitle">Meme Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Image/Video Preview -->
                <div id="memePreview">
                    <img id="memeImage" src="" style="display: none;" alt="Meme preview">
                    <video id="memeVideo" style="display: none;" controls>
                        <source id="memeVideoSource" src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>

                <!-- Meme Details Info -->
                <div id="memeDetails" style="font-size: 0.9rem; color: #666; margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 6px;"></div>

                <!-- Form Fields -->
                <form id="memeForm">
                    <div class="mb-3">
                        <label for="memeCategory" class="form-label">Category</label>
                        <input type="text" id="memeCategory" class="form-control" placeholder="e.g., Political, Funny, Technology">
                    </div>
                    <div class="mb-3">
                        <label for="memeKeywordsInput" class="form-label">Keywords</label>
                        <div id="keywordsBadges" class="mb-2" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 32px;"></div>
                        <input type="text" id="memeKeywordsInput" class="form-control" placeholder="Type and press Enter to add keyword" style="margin-bottom: 8px;">
                        <div id="keywordsList" style="display: none;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="memeTextInImage" class="form-label">Text in Image</label>
                        <input type="text" id="memeTextInImage" class="form-control" placeholder="Text visible in the image">
                    </div>
                    <div class="mb-3">
                        <label for="memeDescription" class="form-label">Description</label>
                        <textarea id="memeDescription" class="form-control" rows="4" placeholder="Detailed description of the meme"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" id="recalcPhashBtn" onclick="recalculatePhash(currentMemeId)" style="display: none;" title="Recalculate perceptual hash">üîÑ Recalc Phash</button>
                <button type="button" class="btn btn-info" id="dedupeBtn" onclick="showDeduplicationModal()" style="display: none;" title="Show duplicate memes">üîó Show Duplicates</button>
                <button type="button" class="btn btn-success" onclick="downloadMeme()" title="Download raw image/video">‚¨áÔ∏è Download</button>
                <button type="button" class="btn btn-primary" onclick="saveMeme()">üíæ Save Changes</button>
                <button type="button" class="btn btn-danger" onclick="markRemoved()">üóëÔ∏è Remove</button>
            </div>
        </div>
    </div>
</div>

<!-- Deduplication Modal -->
<div class="modal fade" id="deduplicationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Duplicates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deduplicationContent">
                <!-- Deduplication panel will be inserted here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/app.js?v=3"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded');
        if (document.getElementById('memesContainer')) {
            console.log('Calling loadMemes');
            loadMemes();
        } else {
            console.log('memesContainer not present ‚Äî skipping loadMemes');
        }
        checkDuplicatesButton();
    });
</script>
{% endblock %}
