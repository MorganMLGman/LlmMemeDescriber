name: Build and push multi-arch image

on:
  push:
    tags: 
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python (for tests)
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'

      - name: Install pipenv
        run: python -m pip install --upgrade pip pipenv

      - name: Install dependencies (pipenv)
        run: pipenv install --dev --deploy --ignore-pipfile
        env:
          PIPENV_VENV_IN_PROJECT: 1

      - name: Run tests (pytest)
        run: pipenv run pytest -q
        env:
          PIPENV_VENV_IN_PROJECT: 1

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: arm64,amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Log in to Docker Registry dhi.io
        uses: docker/login-action@v2
        with:
          registry: dhi.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Lowercase names
        id: names
        run: |
          dockerhub_username_lower=$(echo '${{ secrets.DOCKERHUB_USERNAME }}' | tr '[:upper:]' '[:lower:]')
          repo_owner_lower=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          echo "dockerhub_username_lower=$dockerhub_username_lower" >> $GITHUB_OUTPUT
          echo "repo_owner_lower=$repo_owner_lower" >> $GITHUB_OUTPUT

      - name: Build time
        id: build_time
        run: |
          echo "iso8601=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Docker metadata
        id: meta
        if: ${{ !(github.event_name == 'workflow_dispatch' && github.ref_name == '') }}
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ steps.names.outputs.dockerhub_username_lower }}/llm-meme-describer
            ghcr.io/${{ steps.names.outputs.repo_owner_lower }}/llm-meme-describer
          tags: |
            type=ref,event=tag,pattern={{ref_name}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}},enable=${{ !startsWith(github.ref, 'refs/tags/v0.') }}
            type=sha
          flavor: |
            latest=auto
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.build_time.outputs.iso8601 }}
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.version=${{ github.ref_name }}

      - name: Docker metadata (workflow_dispatch fallback)
        id: meta_fallback
        if: ${{ github.event_name == 'workflow_dispatch' && github.ref_name == '' }}
        run: |
          DOCKERHUB_USER=${{ steps.names.outputs.dockerhub_username_lower }}
          GHCR_OWNER=${{ steps.names.outputs.repo_owner_lower }}

          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "${DOCKERHUB_USER}/llm-meme-describer:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "ghcr.io/${GHCR_OWNER}/llm-meme-describer:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "labels<<EOF" >> $GITHUB_OUTPUT
          echo "org.opencontainers.image.revision=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "org.opencontainers.image.created=${{ steps.build_time.outputs.iso8601 }}" >> $GITHUB_OUTPUT
          echo "org.opencontainers.image.source=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "org.opencontainers.image.version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Compose final metadata
        id: final_meta
        run: |
          if [ -n "${{ steps.meta.outputs.tags }}" ]; then
            echo "tags<<EOF" >> $GITHUB_OUTPUT
            echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "labels<<EOF" >> $GITHUB_OUTPUT
            echo "${{ steps.meta.outputs.labels }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "tags<<EOF" >> $GITHUB_OUTPUT
            echo "${{ steps.meta_fallback.outputs.tags }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "labels<<EOF" >> $GITHUB_OUTPUT
            echo "${{ steps.meta_fallback.outputs.labels }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi



      - name: Build and push multi-arch image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.final_meta.outputs.tags }}
          labels: ${{ steps.final_meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
