name: Build and Push Multi-Architecture Docker Image

on:
  push:
    tags: 
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

env:
  IMAGE_NAME: llm-meme-describer

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip pipenv
          pipenv install --dev --deploy --ignore-pipfile
        env:
          PIPENV_VENV_IN_PROJECT: 1
      
      - name: Run tests
        run: pipenv run pytest -q
        env:
          PIPENV_VENV_IN_PROJECT: 1

  build:
    name: Build ${{ matrix.platform }} Image
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
        include:
          - platform: linux/amd64
            arch: amd64
          - platform: linux/arm64 
            arch: arm64
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v2
        with:
          platforms: arm64
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to registries
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login dhi.io -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
      
      - name: Generate metadata
        id: meta
        run: |
          echo "build_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          REPO_OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          echo "tag=ghcr.io/$REPO_OWNER/${{ env.IMAGE_NAME }}:check-${{ github.sha }}-${{ matrix.arch }}" >> $GITHUB_OUTPUT
      
      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: true
          build-args: TARGETARCH=${{ matrix.arch }}
          tags: ${{ steps.meta.outputs.tag }}
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.meta.outputs.build_time }}
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.version=${{ github.ref_name }}
          cache-from: type=gha,scope=${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ matrix.arch }}
      
      - name: Test Python imports
        run: |
          docker run --rm --platform ${{ matrix.platform }} --entrypoint /app/.venv/bin/python \
            ${{ steps.meta.outputs.tag }} -c "import pydantic_core._pydantic_core; print('✅ Python imports OK')"
      
      - name: Test ffmpeg availability
        run: |
          docker run --rm --platform ${{ matrix.platform }} --entrypoint "" ${{ steps.meta.outputs.tag }} ffmpeg -version
          docker run --rm --platform ${{ matrix.platform }} --entrypoint "" ${{ steps.meta.outputs.tag }} ffprobe -version
          echo "✅ ffmpeg/ffprobe OK"

  publish:
    name: Create Multi-Architecture Manifest
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to registries
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login dhi.io -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin  
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
      
      - name: Generate tags
        id: tags
        run: |
          DOCKERHUB_USER=$(echo '${{ secrets.DOCKERHUB_USERNAME }}' | tr '[:upper:]' '[:lower:]')
          REPO_OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # Ensure VERSION follows semantic versioning: MAJOR.MINOR.PATCH with numeric components
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Tag '$VERSION' is not a valid semantic version (expected format: MAJOR.MINOR.PATCH)." >&2
            exit 1
          fi

          MAJOR=${VERSION%%.*}
          MINOR=${VERSION%.*}
          
          TAGS=(
            "$DOCKERHUB_USER/${{ env.IMAGE_NAME }}:$VERSION"
            "$DOCKERHUB_USER/${{ env.IMAGE_NAME }}:$MINOR" 
            "$DOCKERHUB_USER/${{ env.IMAGE_NAME }}:latest"
            "ghcr.io/$REPO_OWNER/${{ env.IMAGE_NAME }}:$VERSION"
            "ghcr.io/$REPO_OWNER/${{ env.IMAGE_NAME }}:$MINOR"
            "ghcr.io/$REPO_OWNER/${{ env.IMAGE_NAME }}:latest"
          )
          
          # Don't tag major version for 0.x releases
          if [[ ! $VERSION =~ ^0\. ]]; then
            TAGS+=("$DOCKERHUB_USER/${{ env.IMAGE_NAME }}:$MAJOR")
            TAGS+=("ghcr.io/$REPO_OWNER/${{ env.IMAGE_NAME }}:$MAJOR")
          fi
          
          printf '%s\n' "${TAGS[@]}" | tee tags.txt
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          printf '%s\n' "${TAGS[@]}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create and push multi-arch manifests
        run: |
          REPO_OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          while IFS= read -r tag; do
            echo "Creating manifest for: $tag"
            docker buildx imagetools create --tag "$tag" \
              ghcr.io/$REPO_OWNER/${{ env.IMAGE_NAME }}:check-${{ github.sha }}-amd64 \
              ghcr.io/$REPO_OWNER/${{ env.IMAGE_NAME }}:check-${{ github.sha }}-arm64
          done < tags.txt
          
          echo "✅ Multi-architecture manifests created successfully"

  publish-dispatch:
    name: Create SHA-based Images (Manual Trigger)
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to registries
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login dhi.io -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin  
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
      
      - name: Create SHA-based tags
        run: |
          DOCKERHUB_USER=$(echo '${{ secrets.DOCKERHUB_USERNAME }}' | tr '[:upper:]' '[:lower:]')
          REPO_OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          SHORT_SHA=${GITHUB_SHA:0:7}
          
          TAGS=(
            "$DOCKERHUB_USER/${{ env.IMAGE_NAME }}:sha-$SHORT_SHA"
            "ghcr.io/$REPO_OWNER/${{ env.IMAGE_NAME }}:sha-$SHORT_SHA"
          )
          
          for tag in "${TAGS[@]}"; do
            echo "Creating manifest for: $tag"
            docker buildx imagetools create --tag "$tag" \
              ghcr.io/$REPO_OWNER/${{ env.IMAGE_NAME }}:check-${{ github.sha }}-amd64 \
              ghcr.io/$REPO_OWNER/${{ env.IMAGE_NAME }}:check-${{ github.sha }}-arm64
          done
          
          echo "✅ SHA-based manifests created successfully"