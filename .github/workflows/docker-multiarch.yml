name: Build and push multi-arch image

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Log in to Docker Registry dhi.io
        uses: docker/login-action@v2
        with:
          registry: dhi.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Lowercase names
        id: names
        run: |
          dockerhub_username_lower=$(echo '${{ secrets.DOCKERHUB_USERNAME }}' | tr '[:upper:]' '[:lower:]')
          repo_owner_lower=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          echo "dockerhub_username_lower=$dockerhub_username_lower" >> $GITHUB_OUTPUT
          echo "repo_owner_lower=$repo_owner_lower" >> $GITHUB_OUTPUT

      - name: Compute tags
        id: tags
        env:
          REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          sha_full="${GITHUB_SHA}"

          # If REF_NAME is empty (workflow_dispatch without tag), only use full sha
          if [ -z "$REF_NAME" ] || [ "$REF_NAME" = "" ]; then
            echo "tags=$sha_full" >> $GITHUB_OUTPUT
            exit 0
          fi

          ref="$REF_NAME"
          tag_no_v="${ref#v}"
          IFS='.' read -r major minor patch <<< "$tag_no_v"

          major_tag="v${major}"
          tags_list="$sha_full $ref $major_tag"
          if [ -n "$minor" ]; then
            minor_tag="v${major}.${minor}"
            tags_list="$tags_list $minor_tag"
          fi
          tags_list="$tags_list latest"

          echo "tags=$tags_list" >> $GITHUB_OUTPUT

      - name: Build and push multi-arch image
        run: |
          TAGS="${{ steps.tags.outputs.tags }}"
          echo "Computed tags: $TAGS"

          DOCKERHUB_USER=${{ steps.names.outputs.dockerhub_username_lower }}
          GHCR_OWNER=${{ steps.names.outputs.repo_owner_lower }}

          # Buildx supports multiple --tag flags; construct them for each registry
          TAG_ARGS=""
          for t in $TAGS; do
            TAG_ARGS="$TAG_ARGS --tag ${DOCKERHUB_USER}/llm-meme-describer:$t --tag ghcr.io/${GHCR_OWNER}/llm-meme-describer:$t"
          done

          # Run buildx with all tags and push
          eval "docker buildx build --platform linux/amd64,linux/arm64 $TAG_ARGS --push ."
