services:
  llm-meme-describer:
    image: morganmlg/llm-meme-describer:latest
    container_name: llm-meme-describer
    user: "1000:1000"
    ports:
      - "8443:8443"
    
    # Volume mounts
    volumes:
      # Main data directory for caching and database
      - ./data:/data

    # Environment variables
    environment:
      # ========== REQUIRED VARIABLES ==========
      
      # === Google Generative AI Configuration (REQUIRED) ===
      # Note: GOOGLE_GENAI_API_KEY is provided via secrets (see below)
      # GOOGLE_GENAI_API_KEY: "<your_api_key_here>" # if not using secrets
      
      # === WebDAV Configuration (REQUIRED for remote storage) ===
      # Base URL of WebDAV server (with full path to collection)
      WEBDAV_URL: "https://example.com/remote.php/dav/files/user"
      # Path within WebDAV to scan for images
      WEBDAV_PATH: "/Path/To/Images"
      # Note: WEBDAV_USERNAME and WEBDAV_PASSWORD are provided via secrets
      # WEBDAV_USERNAME: "<your_username_here>" # if not using secrets
      # WEBDAV_PASSWORD: "<your_password_here>" # if not using secrets
      
      # ========== OPTIONAL VARIABLES (with defaults) ==========
      
      # === Logging Configuration ===
      # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
      # Default: INFO
      LOGGING_LEVEL: "INFO"
      
      # === Timezone ===
      # IANA timezone for log timestamps (e.g., UTC, Europe/Warsaw, America/New_York)
      # Default: UTC
      TIMEZONE: "UTC"
      
      # === SSL/TLS Configuration (OPTIONAL) ===
      # If no certificates provided, self-signed certificates are auto-generated in /data/certs/
      # This is safe for development and when deployed behind a reverse proxy (e.g., Cloudflare)
      # 
      # For production with provided certificates (via secrets or files):
      # SSL_CERT_FILE: "/run/secrets/ssl_cert_file"  # Certificate (PEM format)
      # SSL_KEY_FILE: "/run/secrets/ssl_key_file"    # Private key (PEM format)
      # SSL_HOSTNAME: "example.com"                   # CN for self-signed cert generation
      #
      # The app listens on https://0.0.0.0:8443 (HTTPS only)
      # Access via: https://localhost:8443 (localhost) or https://your-domain.com (behind proxy)
      
      # === Google Generative AI Configuration ===
      # Model to use for analysis
      # Default: gemini-3-flash-preview
      GOOGLE_GENAI_MODEL: "gemini-3-flash-preview"
      
      # === Processing Configuration ===
      # Interval between sync/processing runs (e.g., 15min, 1h, 30s)
      # The service scans WebDAV for new/removed files and generates descriptions at this interval
      # Default: 15min
      RUN_INTERVAL: "15min"
      # Maximum attempts to generate description for a meme
      # Default: 3
      MAX_GENERATION_ATTEMPTS: "3"
      # Enable automatic background worker (recommended: true)
      # Default: true
      AUTO_START_WORKER: "true"
      
      # === Advanced Configuration ===
      # Number of concurrent storage workers
      # Default: 4
      STORAGE_WORKERS: "4"
      # Storage concurrency limit
      # Default: 2
      STORAGE_CONCURRENCY: "2"
      # Maximum records to sync per batch
      # Default: 500
      SYNC_MAX_RECORDS: "500"
    
    # Docker Secrets (for sensitive data)
    secrets:
      - google_genai_api_key
      - webdav_username
      - webdav_password
      # Optional: SSL certificate secrets (for production deployments)
      # Uncomment if providing your own certificates:
      # - ssl_cert_file
      # - ssl_key_file
    
    # Restart policy
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,ssl,sys; ctx=ssl.create_default_context(); ctx.check_hostname=False; ctx.verify_mode=ssl.CERT_NONE; urllib.request.urlopen('https://localhost:8443/health', context=ctx, timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# Secret definitions
secrets:
  google_genai_api_key:
    file: ./secrets/google_genai_api_key
  
  webdav_username:
    file: ./secrets/webdav_username
  
  webdav_password:
    file: ./secrets/webdav_password
  
  # Optional: SSL certificate secrets for production deployments
  # If using your own certificates, uncomment and update paths:
  # ssl_cert_file:
  #   file: ./certs/server.crt
  # ssl_key_file:
  #   file: ./certs/server.key
